\chapter{Derived moduli stacks}
\chapterprecistoc{\textup{by} Pieter Belmans}
\begin{flushright}
  Pieter Belmans
\end{flushright}

\begin{refsection}

\section{Introduction}
Moduli problems are situations in which you try to describe a ``family of objects'' using geometry. Some examples of well-known moduli problems are
\begin{itemize}
  \item the Hilbert scheme: parametrising closed subschemes of a given scheme;
  \item the moduli of curves of genus~$g$;
  \item the moduli of vector bundles of rank~$n$ on an algebraic variety.
\end{itemize}
The goal is to find a scheme, algebraic space or stack which represents the moduli problem. This was (and still is) one of the motivating reasons for the development of algebraic geometry, and whenever a moduli problem is representable it yields an example of a (often highly non-trivial) space. A striking example of this is the moduli of curves of genus~$g$ which for various~$g$ yields objects of greatly varying complexity.

But there can be certain problems with this approach:
\begin{enumerate}
  \item the moduli problem at hand is not suited for the language of ``classical'' algebraic geometry\footnote{Often classical means Italian, but in this case it means the geometry from the sixties using commutative rings as building blocks.}: more difficult objects are involved, we only consider objects up to quasi-isomorphism, \dots;
  \item the result of the moduli problem is not as nice as one would hope for: the \emph{hidden (quasi)smoothness principle} formulated by Be\u\i linson--Deligne--Drinfel'd--Kontsevich says singular moduli spaces are the ``shadow'' of smooth moduli spaces in a more general context.
\end{enumerate}
We will now give examples of these problems. We first state the classical case, and then we remark how derived algebraic geometry will address the problems that exist with these examples.
\begin{example}[Moduli of objects in a $k$\dash linear category]
  Let~$\mathcal{C}$ be a~$k$\dash linear category. As in chapter \ref{chapter:dg} we take~$k$ a commutative ring, not necessarily a field. We then define the moduli problem
  \begin{equation}
    \mathcal{M}_{\mathcal{C}}\colon k\mhyphen\mathbf{c\,Alg}\to\mathbf{Grpd}:A\mapsto\Fun_k(\mathcal{C}^\opp,k\mhyphen\Mod^{\mathrm{ft,proj}})
  \end{equation}
  by considering the groupoid of~$k$\dash linear functors from~$\mathcal{C}$ to the category of projective~$A$\dash modules of finite type. If we take~$\mathcal{C}=k$ (the category with a single object and~$k$ as its endomorphism ring) this is the category of vector bundles on~$\Spec A$, and the proof uses this fact. The tensor product
  \begin{equation}
    B\otimes_A-\colon A\mhyphen\Mod^{\mathrm{ft,proj}}\to B\mhyphen\Mod^{\mathrm{ft,proj}}
  \end{equation}
  yields morphism a~$\mathcal{M}_{\mathcal{C}}(A)\to\mathcal{M}_{\mathcal{C}}(B)$, and this gives a stack of the big \'etale site of affine~$k$\dash schemes.

  If~$\mathcal{C}$ is of finite type as a~$k$\dash linear category, i.e.\ the category~$\mathcal{C}^\opp\mhyphen\Mod$ is equivalent to~$B\mhyphen\Mod$ where~$B$ is a finitely presented associative~$k$\dash algebra\footnote{We enter the realm of not necessarily commutative objects.}, then~$\mathcal{M}_{\mathcal{C}}$ is an Artin stack, locally of finite presentation.

  This gives the mere existence of an Artin stack, but we need more conditions on~$\mathcal{C}$ to have a good relationship between the~$k$\dash rational points~$\mathcal{M}_{\mathcal{C}}(k)$ and~$\mathcal{C}$ itself \cite[remark 1.2]{toen-vaquie}.
\end{example}

\begin{remark}
  We can ask the same thing for dg~categories, which are~$k$\dash linear categories with some extra structure. But whereas we are interested in isomorphisms in the classical case (and where the presence of automorphisms yields the necessity of stacks) we care about quasi-isomorphisms in case of dg~categories. Unfortunately the formalism of triangulated categories doesn't glue \cite{lnm2008}.
  
  Remark that the conditions for a good relationship between the~$k$\dash rational points and the category are more easily satisfied in this case, as will be explained in section~\ref{section:example}.
\end{remark}

\begin{example}[Vector bundles of rank $n$]
  
\end{example}

\section{Preliminaries}
\label{section:preliminaries}
Whenever the terminology ``derived stack'' is used we refer to the~$\mathbf{D}^-$\dash stacks from \cite{hagII}. The notation~$\mathbf{D}^-$ is reminiscent of the objects involved: cochain complexes concentrated in non-positive degrees, related to the use of simplicial commutative rings and the Dold-Kan correspondence.

\begin{definition}
  Let~$\mathcal{C}$ be a dg~category. The \emph{derived moduli stack of pseudoperfect~$\mathcal{C}^\opp$\dash dg~modules}~$\mathcal{M}_{\mathcal{C}}$ is given by the simplicial presheaf
  \begin{equation}
    \mathcal{M}_{\mathcal{C}}:\scAlg{k}\to\sSet:A^*\mapsto\Map_{\dgCat_K}\left( \mathcal{C}^\opp,\Int_\perf\left( \dgMod{\nerve(A^*)^\bullet}_k \right) \right).
  \end{equation}
\end{definition}

We remark that
\begin{enumerate}
  \item the opposite dg~category is again a dg~category, with composition
    \begin{equation}
      \Hom_{\mathcal{C}^\opp}(X,Y)^p\otimes_k\Hom_{\mathcal{C}^\opp}(Y,Z)^q\to\Hom_{\mathcal{C}^\opp}(X,Z)^{p+q}:f\otimes g\mapsto(-1)^{pq}gf;
    \end{equation}
  \item the simplicial structure of~$\dgCat_k$ is given by
    \begin{equation}
      \Map_{\dgCat_k}(\mathcal{C},\mathcal{D})\coloneqq\Hom_{\dgCat_k}(\Gamma^*(\mathcal{C}),\mathcal{D})
    \end{equation}
    where~$\Gamma^*$ is the cosimplicial resolution functor;
  \item the subcategory of perfect objects is stable under base change.
\end{enumerate}

\begin{definition}
  If we take~$\mathcal{C}=k$ in definition \ref{definition:derived-stack-of-pseudoperfect-objects} we obtain the \emph{derived moduli stack of perfect modules}. It will be denoted~$\RPerf$.
\end{definition}

In the notation of \cite{toen-vaquie} we have~$k=\mathbf{1}$ and~$\RPerf$ is denoted by~$\mathcal{M}_{\mathbf{1}}$.

This derived stack serves as a ``base point'' for all other constructions. One first proves the properties for~$\RPerf$ (see theorem \ref{theorem:main-theorem-RPerf}), then one can try to lift these to derived moduli stacks for arbitraty dg~categories, under some appropriate finiteness conditions (see theorem \ref{theorem:main-theorem}). But first we have to show that it is indeed a derived stack! Recall again that ``derived stack'' should be interpreted in terms of \cite[definition 1.3.2.1]{hagII}.

First of all, we have to prove that this base stack is in fact a stack \cite[lemma 3.1]{toen-vaquie}.

\begin{theorem}
  \label{theorem:derived-moduli-stack-is-stack}
  The simplicial presheaf~$\mathcal{M}_{\mathcal{C}}$ is a derived stack.

  \begin{proof}[Proof]
    As discussed in \cite[\S 2.1.1]{hagII} the proof is reduced to showing the following three properties:
    \begin{enumerate}
      \item for every weak equivalence~$A^*\weq B^*$ in~$\scAlg{k}$ is the natural morphism
        \begin{equation}
          \label{equation:condition-1}
          \Int_\perf\left( \dgMod{\nerve(A^*)^\bullet}_k \right)\weq\Int_\perf\left( \dgMod{\nerve(B^*)^\bullet}_k \right)
        \end{equation}
        a quasi-equivalence;
      \item for every~$A^*$ and~$B^*$ in~$\scAlg{k}$ is the natural morphism
        \begin{equation}
          \Int_\perf\left( \dgMod{\nerve\left( A^*\times B^*)^\bullet}_k \right) \right)\weq\Int_\perf\left( \dgMod{\nerve(A^*)^\bullet}_k \right)\times\Int_\perf\left( \dgMod{\nerve(B^*)^\bullet}_k \right)
        \end{equation}
        a quasi-equivalence;
      \item for every \'etale hypercovering~$X_*\to Y$ in~$\mathbf{D}^-\Aff$, or equivalently a co-augmented cosimplicial object~$A^*\to B_*^*$ in~$\scAlg{k}$ is
        \begin{equation}
          \label{equation:condition-3}
          \Int_\perf\left( \dgMod{\nerve(A^*)^\bullet}_k \right)\weq\holim_{[n]\in\Ob(\Delta)}\Int_\perf\left( \dgMod{B^n}_k \right)
        \end{equation}
        a quasi-equivalence.
    \end{enumerate}
    Or in a more sloganesque way\fixthis{this should be used in the actual lecture}
    \begin{enumerate}
      \item $\mathcal{M}_{\mathcal{C}}$ preserves weak equivalences;
      \item $\mathcal{M}_{\mathcal{C}}$ is compatible with finite products;
      \item $\mathcal{M}_{\mathcal{C}}$ is compatible with \'etale hypercovers.
    \end{enumerate}

    \expandthis{write complete proof?}
    
    Let~$A^*\weq B^*$ be a weak equivalence. The base change~$B^*\otimes_{A^*}-$ is a Quillen equivalence \addreference, so we obtain a quasi-equivalence~$\Int(\dgMod{\nerve(A^*)^\bullet}_k)\to\Int(\dgMod{\nerve(B^*)^\bullet}_k)$ \addreference. This then descends to the full dg~subcategories of perfect objects, hence \eqref{equation:condition-1} is a quasi-equivalence and~$\RPerf$ satisfies property~1.

    By \cite[corollary 1.3.7.4]{hagII} we have that perfectness is \'etale local, hence we can drop the perfectness condition when proving properties~2 and~3. We then observe that
    \begin{equation}
      \Int\left( \dgMod{\nerve\left( A^*\times B^*)^\bullet}_k \right) \right)\to\Int\left( \dgMod{\nerve(A^*)^\bullet}_k \right)\times\Int\left( \dgMod{\nerve(B^*)^\bullet}_k \right)
    \end{equation}
    is a quasi-equivalence because\expandthis, which proves property~2.

    The last property is slightly more involved, and requires the results from \cite{toen} discussed in section \addreference. First of all, we have reduced \eqref{equation:condition-3} to
    \begin{equation}
      \Int\left( \dgMod{\nerve(A^*)^\bullet}_k \right)\to\holim_{[n]\in\Ob(\Delta)}\Int\left( \dgMod{B^n}_k \right)
    \end{equation}
    by the previous remark. By applying Yoneda we reduce this to proving that
    \begin{equation}
      \Map\left( \mathcal{C},\Int\left( \dgMod{\nerve(A^*)^\bullet}_k \right) \right)\to\Map\left( \mathcal{C},\holim_{[n]\in\Ob(\Delta)}\Int\left( \dgMod{B^n}_k \right) \right)
    \end{equation}
    is a weak equivalence of simplicial sets, for every dg~category~$\mathcal{C}$. By \cite[theorem 4.2]{toen} we have a weak equivalence
    \begin{equation}
      \Map\left( \mathcal{C},\Int\left( \dgMod{\nerve(A^*)^\bullet}_k \right) \right)\weq\nerve\left( \dgMod{(\mathcal{C}\otimes^{\mathbf{L}}\nerve(A^*)^\bullet)}_k^{\mathrm{cof,weq}} \right)
    \end{equation}
    and weak equivalences
    \begin{equation}
      \Map\left( \mathcal{C},\Int\left( \dgMod{\nerve(B_n^*)^\bullet}_k \right) \right)\weq\nerve\left( \dgMod{(\mathcal{C}\otimes^{\mathbf{L}}\nerve(B_n^*)^\bullet)}_k^{\mathrm{cof,weq}} \right)
    \end{equation}
    for each~$n\geq 0$. Hence we have to prove that
    \begin{equation}
      \nerve\left( \dgMod{(\mathcal{C}\otimes^{\mathbf{L}}\nerve(A^*)^\bullet)}_k^{\mathrm{cof,weq}} \right)\to\holim_{[n]\in\Ob(\Delta)}\nerve\left( \dgMod{(\mathcal{C}\otimes^{\mathbf{L}}\nerve(B_n^*)^\bullet)}_k^{\mathrm{cof,weq}} \right)
    \end{equation}
    is a weak equivalence. But this follows from \addreference.
  \end{proof}
\end{theorem}

\begin{example}
  If we evaluate~$\mathcal{M}_{\mathcal{C}}$ in~$k$ we get
  \begin{equation}
    \Map_{\dgCat_k}\left( \mathcal{C}^\opp,\Int_\perf\left( \dgMod_k \right) \right)
  \end{equation}
  and by \cite{toen} this simplicial set is weakly equivalent to the category of weak equivalences of~$\mathcal{C}^\opp$\dash dg~modules~$M$ such that~$M(C)^\bullet$ is a perfect complex of~$k$\dash modules for every~$C\in\Ob(\mathcal{C})$.\fixthis{full reference to result}
\end{example}


\section{Properties of derived moduli stacks}
\label{section:properties}
Before we describe the properties of~$\RPerf$ and more generally~$\mathcal{M}_{\mathcal{C}}$ we introduce some ideas that are necessary for its proof. A reference for this is \cite[expos\'es I--III]{sga6}.
\begin{definition}
  Let~$A^*$ be a simplicial commutative~$k$\dash algebra. Let~$P^\bullet$ be a~$\nerve(A^*)^\bullet$\dash dg~module. We say it is of \emph{Tor amplitude contained in~$[a,b]$} if for every~$\pi_0(A^*)$\dash module~$M\in\Ob(\pi_0(A^*)\mhyphen\Mod)$ we have
  \begin{equation}
    \HH^i\left( P^\bullet\otimes_{\nerve(A^*)^\bullet}^\LLL M \right)=0
  \end{equation}
  if~$i\notin[a,b]$.
\end{definition}

We first prove that the base derived stack~$\RPerf$ is locally geometric and locally of finite presentation \cite[proposition 3.7]{toen-vaquie}, then we lift this in theorem \ref{theorem:main-theorem} to dg~categories satisfying a certain finiteness condition \cite[theorem 3.6]{toen-vaquie}. The full proof of these statements is about 10 pages long, so we have to restrict ourselves to a mere sketch.
\begin{theorem}
  \label{theorem:main-theorem-RPerf}
  The derived moduli stack~$\RPerf$ is locally geometric and locally of finite presentation.

  \begin{proof}[Sketch of a proof]
    We first make the following reduction: let~$a\leq b$ be integers, then there exists a full derived substack~$\RPerf^{[a,b]}$ of~$\RPerf$.
    
    For~$A^*\in\Ob(\scAlg{k})$ we see that~$\pi_0(\RPerf(A^*))$ consists of the quasi-isomorphism classes of perfect~$\nerve(A^*)^\bullet$\dash dg~modules. Hence we can define~$\RPerf^{[a,b]}(A^*)$ to be the full subsimplicial set of~$\RPerf(A^*)$ of connected components that correspond to perfect~$\nerve(A^*)^\bullet$\dash dg~modules whose Tor amplitude is contained in~$[a,b]$. We can then write
    \begin{equation}
      \RPerf=\bigcup_{a\leq b}\RPerf^{[a,b]}
    \end{equation}
    and we have reduced the proof to showing that~$\RPerf^{[a,b]}$ is locally geometric and locally of finite presentation. We can moreover prove that~$\RPerf^{[a,b]}$ is~$n$\dash geometric, where~$n=b-a+1$.

    To prove that~$\RPerf^{[a,b]}$ is~$n$\dash geometric we use \cite[lemma 2.18]{toen-vaquie}, to reduce this to a statement on the diagonal. Hence, let~$X=\mathbf{R}\Spec A^*$ be a representable (or affine) derived stack and let~$f,g\colon X\to\RPerf^{[a,b]}$ be two morphisms. Consider the homotopy fiber product
    \begin{equation}
      \begin{tikzcd}
        X\times_{\RPerf^{[a,b]}}^{\mathrm{h}}X \arrow{r} \arrow{d} & X \arrow{d}{g} \\
        X \arrow[swap]{r}{f} & \RPerf^{[a,b]}.
      \end{tikzcd}
    \end{equation}
    We then have to prove that this homotopy fiber product is~$n-1$\dash geometric. This is done by induction on~$n-1=b-a$. If~$a=b$, we have that~$\RPerf^{[a,a]}$ is the derived stack of vector bundles \cite[corollary 1.3.7.4]{hagII}, which finishes this case.

    Now let~$a<b$. As~$X$ is affine we have a simplicial commutative~$k$\dash algebra~$A^*$ representing it, and~$f$ and~$g$ are two~$A^*$\dash rational points of~$\RPerf^{[a,b]}$, hence they correspond to two perfect~$\nerve(A^*)^\bullet$\dash dg~modules whose Tor amplitude is contained in~$[a,b]$.

    \expandthis{finish proof}
  \end{proof}
\end{theorem}

\begin{theorem}
  \label{theorem:main-theorem}
  Let~$\mathcal{C}$ be a dg~category of finite type. Then the derived moduli stack~$\mathcal{M}_{\mathcal{C}}$ is locally geometric and locally of finite presentation.

  \begin{proof}[Sketch of a proof]
    We can again make the decomposition
    \begin{equation}
      \mathcal{M}_{\mathcal{C}}=\bigcup_{a\leq b}\mathcal{M}_{\mathcal{C}}^{[a,b]}
    \end{equation}
    hence it suffices to prove that~$\mathcal{M}_{\mathcal{C}}^{[a,b]}$ is locally geometric and locally of finite presentation. We can actually proof that it is~$n$\dash geometric for some value of~$n$, which cannot be expressed in terms of~$a$ and~$b$ alone, but also depends on the number of generators used in the homotopically finite presentation of the dg~algebra~$B^\bullet$ that represents~$\mathcal{C}$ (as it is assumed to be of finite type) by \cite[corollary 2.12]{toen-vaquie}.

    Hence to lift the result on~$\RPerf$ we have to prove that the morphism
    \begin{equation}
      \pi\colon\mathcal{M}_{\mathcal{C}}^{[a,b]}\to\RPerf^{[a,b]}
    \end{equation}
    is~$n$ representable (for some~$n$) and strongly of finite presentation\addreference{this then implies the result?}.
  \end{proof}
\end{theorem}

\section{Example: derived moduli stack of perfect complexes on a scheme}
\label{section:example}
Consider a smooth and proper scheme~$X$ over a field~$k$. By~$\Qcoh_X$ we denote its category of quasicoherent sheaves. In general there is no obvious model category structure on~$\Ch(\Qcoh(X))$. But in this case~$X$ is quasicompact and separated, so by \cite{hovey-sheaves} there exists a model category structure on~$\Ch(\Qcoh_X)$ where the cofibrations are the monomorphisms and weak equivalences are quasi-isomorphisms. There is moreover an obvious~$\Ch(k\mhyphen\Mod)$\dash enrichment, so~$\Ch(\Qcoh_X)$ is a~$\Ch(k\mhyphen\Mod)$\dash model category. Using the internal dg~category as seen in definition~\ref{definition:internal-dg-category} we can define
\begin{equation}
  \LLL_\qcoh(X)\coloneqq\Int\left( \Ch(\Qcoh_X) \right).
\end{equation}
By proposition \ref{proposition:internal-category-is-dg-enrichtment} this category serves as a dg~enrichment of the ``standard'' unbounded derived category of quasicoherent sheaves, in the sense that
\begin{equation}
  \mathbf{D}_\qcoh(X)\cong\Ho\left( \LLL_\qcoh(X) \right).
\end{equation}
If we restrict ourselves to the perfect objects in\fixthis{introduce~$\LLL_\perf$} we obtain the equivalence
\begin{equation}
  \mathbf{D}_\perf(X)\cong\Ho\left( \LLL_\perf(X) \right),
\end{equation}
where now the smoothness comes into play.

In order to apply the theory of derived moduli stacks certain finiteness conditions on the categories must be satisfied. Crucial in this is the result from \cite{bondal-vandenbergh}. One could paraphrase the main result as
\begin{quote}
  Quasicompact and quasiseparated\footnote{The intersection of two affine opens is again affine. This is always the case for separated schemes.} schemes are \emph{derived affine}.
\end{quote}
\begin{flushright}
  \cite[corollary 3.1.8]{bondal-vandenbergh}
\end{flushright}
This means that~$\mathbf{D}_\qcoh(X)$ is equivalent to~$\mathbf{D}(A^\bullet)$, where~$A^\bullet$ is a dg~algebra with bounded cohomology. This algebra is moreover obtained by looking at~$\Ext^\bullet(E,E)$ where~$E$ is a compact generator for~$\mathbf{D}_\qcoh(X)$.

We can then define the desired derived moduli stack.
\begin{definition}
  Let~$X$ be as before. We define the \emph{derived moduli stack of perfect complexes on~$X$} as
  \begin{equation}
    \RPerf_X\coloneqq\mathcal{M}_{\LLL_\perf(X)}\cong\HHom_{\mathbf{D}^-\mhyphen\St_k}(X,\RPerf)
  \end{equation}
\end{definition}

\begin{remark}
  We can prove that the dg~category~$\LLL_\perf(X)$ is saturated, so by remark \fixthis{write this remark} we get that~$\RPerf_X$ really classifies objects in~$\LLL_\perf(X)$.
\end{remark}

\begin{remark}
  Given this derived stack we can also consider its truncation, or underived part. We'll denote this higher stack by
  \begin{equation}
    \Perf_X\coloneqq\truncation_0(\RPerf_X).
  \end{equation}
  If one moreover restricts himself to the substack of~$1$\dash rigid objects\footnote{These are objects satisfying the vanishing of all higher homotopy groups for all base changes.} we obtain the classical result of the existence of an Artin stack~$\Coh_X$\checkthis{or $\Vect_X$ as in the introduction?!} that serves as a moduli space for coherent sheaves on~$X$ \cite[th\'eor\`eme 4.6.2.1]{laumon-moret-bailly} \cite[tag 08CW]{stacks}.
\end{remark}


\section{Example: derived moduli stack of pseudoperfect complexes of quiver representations}
\label{section:example-2}

\printbibliography[heading = local]

\end{refsection}
